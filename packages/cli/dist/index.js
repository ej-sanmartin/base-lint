#!/usr/bin/env node
import{Command as It}from"commander";import A from"path";import{globby as lt}from"globby";import{minimatch as ut}from"minimatch";import mt from"ignore";import{promises as Ue}from"fs";import oe from"path";import{parse as Re}from"@typescript-eslint/typescript-estree";var ke=Re;function C(e,t){try{return ke(e,{loc:!0,range:!0,jsx:t.endsWith("x"),comment:!1,errorOnUnknownASTType:!1,useJSXTextNode:!0,warnOnUnsupportedTypeScriptVersion:!1,loggerFn:()=>{}})}catch{return null}}function R(e,t,r=null){t(e,r);for(let n of Object.keys(e)){let i=e[n];if(i)if(Array.isArray(i))for(let o of i)o&&typeof o=="object"&&"type"in o&&R(o,t,e);else typeof i=="object"&&"type"in i&&R(i,t,e)}}import Ie from"postcss";function _(e,t){try{return Ie.parse(e,{from:t})}catch{return null}}function K(e,t){e.walk(r=>{(r.type==="rule"||r.type==="atrule")&&t(r)})}import{parse as Pe,HTMLElement as $e}from"node-html-parser";function Q(e){let t=Pe(e,{script:!0,style:!0,comment:!1}),r=[],n=t.querySelectorAll("script, style");for(let i of n)if(i instanceof $e){if(i.tagName==="SCRIPT"){if(i.getAttribute("src"))continue;let s=i.innerHTML;r.push({type:"script",content:s,line:Y(e,X(i))})}else if(i.tagName==="STYLE"){let o=i.innerHTML;r.push({type:"style",content:o,line:Y(e,X(i))})}}return r}function Y(e,t){return t<=0?1:e.slice(0,t).split(/\r?\n/).length}function X(e){if(Array.isArray(e.range)&&e.range.length>0)return e.range[0];let t=e.toString(),r=e.root;return r?r.toString().indexOf(t):0}function D(e,t){let r=[];return R(e,(n,i)=>{if(n.type==="MemberExpression"){let o=Fe(n,t);o&&r.push(o)}else if(n.type==="NewExpression"){let o=Ce(n);o&&r.push(o)}else if(n.type==="Identifier"){let o=_e(n,i);o&&r.push(o)}}),r}function L(e){let t=[];return K(e,r=>{if(r.type==="rule"){let n=r.selector??"";n.includes(":has(")&&t.push(O("has",":has() selector",r)),n.includes(":where(")&&t.push(O("where",":where() selector",r))}r.type==="atrule"&&r.name==="container"&&t.push(O("container-queries","@container queries",r))}),t}function Fe(e,t){if(!t.strict&&e.computed)return null;let r=E(e.object),n=e.property&&e.property.type==="Identifier"?e.property.name:null;return!r||!n?null:{"navigator.share":{featureId:"share",featureName:"Web Share API",line:e.property.loc?.start.line??e.loc?.start.line??null,column:(e.property.loc?.start.column??e.loc?.start.column??0)+1},"navigator.usb":{featureId:"webusb",featureName:"WebUSB API",line:e.property.loc?.start.line??e.loc?.start.line??null,column:(e.property.loc?.start.column??e.loc?.start.column??0)+1},"Notification.requestPermission":{featureId:"notifications",featureName:"Notifications API",line:e.property.loc?.start.line??e.loc?.start.line??null,column:(e.property.loc?.start.column??e.loc?.start.column??0)+1}}[`${r}.${n}`]??null}function Ce(e){if(e.callee.type==="Identifier"){let t=e.callee.name;if(t==="Notification")return{featureId:"notifications",featureName:"Notifications API",line:e.callee.loc?.start.line??e.loc?.start.line??null,column:(e.callee.loc?.start.column??e.loc?.start.column??0)+1};if(t==="BroadcastChannel")return{featureId:"broadcast-channel",featureName:"BroadcastChannel API",line:e.callee.loc?.start.line??e.loc?.start.line??null,column:(e.callee.loc?.start.column??e.loc?.start.column??0)+1};if(t==="IdleDetector")return{featureId:"idle-detection",featureName:"Idle Detection API",line:e.callee.loc?.start.line??e.loc?.start.line??null,column:(e.callee.loc?.start.column??e.loc?.start.column??0)+1}}return null}function _e(e,t){return e.name==="IdleDetector"?t&&t.type==="NewExpression"&&t.callee===e?null:{featureId:"idle-detection",featureName:"Idle Detection API",line:e.loc?.start.line??null,column:(e.loc?.start.column??0)+1}:null}function O(e,t,r){let n=r.source?.start;return{featureId:e,featureName:t,line:n?.line??null,column:n?n.column+1:null}}function E(e){if(e.type==="Identifier")return e.name;if(e.type==="TSAsExpression"||e.type==="TSTypeAssertion"||e.type==="TSNonNullExpression"||e.type==="ChainExpression")return E(e.expression);if(e.type==="MemberExpression"&&e.property.type==="Identifier"&&!e.computed){let t=E(e.object);if(t)return`${t}.${e.property.name}`}return null}import{readFileSync as Oe}from"fs";import{createRequire as De}from"module";import j from"path";import{pathToFileURL as Z}from"url";var Le=typeof import.meta<"u"&&import.meta.url?import.meta.url:typeof __filename<"u"?Z(__filename).href:Z(j.join(process.cwd(),"index.js")).href,ee=De(Le),je=ee("web-features/data.json"),B="unknown";try{let e=ee.resolve("web-features"),t=j.join(j.dirname(e),"package.json"),r=Oe(t,"utf-8"),n=JSON.parse(r);typeof n.version=="string"&&(B=n.version)}catch{B="unknown"}var te=new Map,Be=je.features??{};for(let[e,t]of Object.entries(Be))te.set(e,{id:e,name:t.name??e,status:{baseline:t.status?.baseline??null},compat_features:t.compat_features??[]});function ne(){return B}function re(e){let t=te.get(e);return t?{level:He(t.status?.baseline),featureName:t.name??e,compatKeys:t.compat_features??[]}:{level:"widely",featureName:e,compatKeys:[]}}function ie(e){switch(e){case"limited":return"Provide fallback UI or feature detection for unsupported browsers.";case"newly":return"OK for modern targets; keep a fallback in place for older browsers.";default:return"No action required."}}function He(e){return e===!1?"limited":e==="low"?"newly":"widely"}import H from"picocolors";function U(e,t){let n=`${e==="info"?H.blue("[base-lint]"):e==="warn"?H.yellow("[base-lint]"):H.red("[base-lint]")} ${t}`;e==="error"?console.error(n):e==="warn"?console.warn(n):console.log(n)}var c={info:e=>U("info",e),warn:e=>U("warn",e),error:e=>U("error",e)};async function ce(e){let{cwd:t,files:r,strict:n,suppress:i,treatNewlyAs:o,cliVersion:s}=e,l=ne(),a=[];for(let p of r){let f=oe.resolve(t,p),h;try{h=await Ue.readFile(f,"utf8")}catch(g){c.warn(`Unable to read ${p}: ${g.message}`);continue}let d=oe.extname(p).toLowerCase();if([".js",".jsx",".ts",".tsx",".mjs",".cjs"].includes(d)){let g=qe(h,p,{strict:n});ae(a,g,i);continue}if(d===".css"||d===".scss"){let g=Je(h,p);ae(a,g,i);continue}if(d===".html"||d===".htm"){let g=await Me(h,p,n,i);a.push(...g);continue}}return a.sort((p,f)=>p.file.localeCompare(f.file)||(p.line??0)-(f.line??0)),{summary:Ge(a),findings:a,meta:{cliVersion:s,datasetVersion:l,strict:n,treatNewlyAs:o,generatedAt:new Date().toISOString()}}}function qe(e,t,r){let n=C(e,t);return n?D(n,{strict:r.strict}).map(o=>k(t,o)):(c.warn(`Unable to parse JavaScript in ${t}`),[])}function Je(e,t){let r=_(e,t);return r?L(r).map(i=>k(t,i)):(c.warn(`Unable to parse CSS in ${t}`),[])}async function Me(e,t,r,n){let i=Q(e),o=[];for(let s of i)if(s.type==="script"){let l=C(s.content,`${t}#inline-script`);if(!l){c.warn(`Unable to parse inline script in ${t}`);continue}let a=D(l,{strict:r});for(let u of a){let m=se(u,s.line),p=k(t,m);n.includes(p.featureId)||o.push(p)}}else if(s.type==="style"){let l=_(s.content,`${t}#inline-style`);if(!l){c.warn(`Unable to parse inline style in ${t}`);continue}let a=L(l);for(let u of a){let m=se(u,s.line),p=k(t,m);n.includes(p.featureId)||o.push(p)}}return o}function se(e,t){return{...e,line:e.line!=null?e.line+t-1:t}}function ae(e,t,r){for(let n of t)r.includes(n.featureId)||e.push(n)}function k(e,t){let r=re(t.featureId),n=ie(r.level);return{file:e,line:t.line??null,column:t.column??null,featureId:t.featureId,featureName:r.featureName||t.featureName,baseline:r.level,guidance:n,ruleId:`baseline/${r.level}`}}function Ge(e){let t={total:e.length,limited:0,newly:0,widely:0};for(let r of e)r.baseline==="limited"?t.limited+=1:r.baseline==="newly"?t.newly+=1:t.widely+=1;return t}function le(e){return JSON.stringify(e,null,2)}function me(e){let t=[];t.push("<!-- base-lint-sticky -->"),t.push("## Base Lint Report"),t.push("");let r=`**Status:** ${Ve(e.summary)}`;if(t.push(r),t.push(""),t.push("| File | Line | Feature | Baseline | Guidance |"),t.push("|------|------|---------|----------|----------|"),e.findings.length===0)t.push("| (none) | - | - | - | Baseline clear |");else for(let n of e.findings){let i=n.line!=null?String(n.line):"-",o=ue(n.featureName),s=ue(n.guidance);t.push(`| ${n.file} | ${i} | ${o} | ${ze(n.baseline)} | ${s} |`)}return t.push(""),t.push(`Policy: Limited = error (max 0), Newly = ${We(e.meta.treatNewlyAs)}`),t.push(`Dataset: web-features ${e.meta.datasetVersion}`),t.join(`
`)}function Ve(e){return[`\u274C Limited: ${e.limited}`,`\u26A0\uFE0F Newly: ${e.newly}`,`\u2705 Widely: ${e.widely}`].join(" \xB7 ")}function We(e){switch(e){case"error":return"error";case"ignore":return"ignored";default:return"warn (non-blocking)"}}function ue(e){return e.replace(/\|/g,"\\|")}function ze(e){return e.charAt(0).toUpperCase()+e.slice(1)}import{promises as I}from"fs";import Ke from"path";async function q(e){await I.mkdir(e,{recursive:!0})}async function P(e,t){await q(Ke.dirname(e)),await I.writeFile(e,t,"utf8")}async function pe(e,t){await P(e,JSON.stringify(t,null,2))}async function T(e){let t=await I.readFile(e,"utf8");return JSON.parse(t)}async function $(e){try{return await I.readFile(e,"utf8")}catch(t){if(t.code==="ENOENT")return null;throw t}}import J from"path";import{promises as Ye}from"fs";var Xe={mode:"diff",treatNewlyAs:"warn",maxLimited:0,strict:!1,targets:"all",suppress:[],include:[],ignore:[]},Qe=["node_modules/","dist/","build/","coverage/","*.min.js"];async function fe(e,t){let r=t.config?J.resolve(e,t.config):J.join(e,"base-lint.config.json"),n=await Ze(r);if(t.config&&!n)throw new Error(`Config file not found at ${r}`);let i={...Xe,...n??{}};if(t.mode){if(!["diff","repo"].includes(t.mode))throw new Error(`Unsupported mode: ${t.mode}`);i.mode=t.mode}if(typeof t.strict=="boolean"&&(i.strict=t.strict),t.treatNewly){if(!["warn","error","ignore"].includes(t.treatNewly))throw new Error(`Unsupported treat-newly option: ${t.treatNewly}`);i.treatNewlyAs=t.treatNewly}i.maxLimited=Number(n?.maxLimited??i.maxLimited),Number.isNaN(i.maxLimited)&&(i.maxLimited=0);let o=Array.isArray(i.suppress)?i.suppress:[],s=Array.isArray(n?.ignore)?n.ignore??[]:[],l=Array.isArray(n?.include)?n.include??[]:[],a=await et(e),u=[...Qe,...s,...a],m=Array.from(new Set(u.filter(Boolean))),p=l;return{config:{...i,suppress:o,ignore:m,include:p},ignorePatterns:m,includePatterns:p,configPath:n?r:void 0}}async function Ze(e){try{let t=await Ye.readFile(e,"utf8");return JSON.parse(t)}catch(t){if(t.code==="ENOENT")return null;throw t}}async function et(e){let t=await $(J.join(e,".base-lintignore"));return t?t.split(/\r?\n/).map(r=>r.trim()).filter(r=>r.length>0&&!r.startsWith("#")):[]}import{promisify as tt}from"util";import{exec as nt}from"child_process";import rt from"path";var it=tt(nt);async function de(e){let t=(await N(["rev-parse","HEAD"],e)).trim(),r=process.env.GITHUB_BASE_REF,n=process.env.GITHUB_SHA,i=await st(),o=null;if(i&&n)o=`${i}...${n}`;else if(r)o=`origin/${r}...${t}`;else{let a=await ot(e).catch(()=>null);a&&(o=`${a}...${t}`)}let s;o?s=["diff","--name-only","--diff-filter=ACMRTUB",o]:s=["diff","--name-only","--diff-filter=ACMRTUB","HEAD"];let l;try{l=await N(s,e)}catch{l=await N(["diff","--name-only","--diff-filter=ACMRTUB","HEAD"],e)}return l.split(/\r?\n/).map(a=>a.trim()).filter(Boolean)}async function N(e,t){let r=`git ${e.join(" ")}`,{stdout:n}=await it(r,{cwd:t});return n}async function ot(e){try{let n=(await N(["merge-base","HEAD","origin/HEAD"],e)).trim();if(n)return n}catch{}let t=["main","master"];for(let n of t)try{let i=(await N(["merge-base","HEAD",n],e)).trim();if(i)return i}catch{}return(await N(["rev-parse","HEAD^"],e)).trim()}async function st(){let e=process.env.GITHUB_EVENT_PATH;if(!e)return null;try{let t=await $(rt.resolve(e));if(!t)return null;let r=JSON.parse(t),n=r?.pull_request?.base?.sha??r?.merge_group?.base_sha;return typeof n=="string"?n:null}catch{return null}}function ge(e,t=5){let n=e.split(`
`).filter((o,s)=>!(s===0&&o.startsWith("<!--"))),i=[];for(let o=0;o<n.length;o+=1){let s=n[o];if(s.startsWith("|------")){i.push(s);let l=[],a=o+1;for(;a<n.length;){let m=n[a];if(!m.startsWith("|"))break;l.push(m),a+=1}let u=l.slice(0,t);if(i.push(...u),l.length>t){let m=l.length-t;i.push(`| \u2026 | \u2026 | \u2026 | \u2026 | \u2026 (${m} more) |`)}o=a-1;continue}s.startsWith("<!--")||i.push(s)}return i.join(`
`).trimEnd()}var ye={name:"base-lint",version:"1.0.7",description:"Lint your repo against Web Baseline policies",license:"MIT",bugs:{url:"https://github.com/ej-sanmartin/base-lint/issues"},homepage:"https://github.com/ej-sanmartin/base-lint#readme",repository:{type:"git",url:"https://github.com/ej-sanmartin/base-lint",directory:"packages/cli"},funding:{type:"individual",url:"https://Ko-fi.com/esanmartin"},type:"module",bin:{"base-lint":"dist/index.js"},files:["dist"],imports:{vitest:"../../tests/mocks/vitest.js"},scripts:{build:"tsup --config tsup.config.ts",dev:"tsx src/index.ts --help",prepublishOnly:"npm run build"},dependencies:{"@typescript-eslint/typescript-estree":"^6.21.0",commander:"^11.1.0",globby:"^13.2.2",ignore:"^5.3.1",minimatch:"^9.0.3","node-html-parser":"^6.1.11",picocolors:"^1.0.0",postcss:"^8.4.35","web-features":"^2.0.0"},devDependencies:{"@types/node":"^20.11.30",tsup:"^8.0.1",tsx:"^4.7.1",typescript:"^5.4.2"},keywords:["lint","baseline","eslint","stylelint","typescript","javascript","css","cli","ci","bot","static-analysis","code-quality","code-style","automation","best-practices"]};import ct from"path";var w=".base-lint-report",v=ct.join(w,"report.json");var pt=[".js",".jsx",".ts",".tsx",".mjs",".cjs",".css",".scss",".html",".htm"];async function he(e){let t=process.cwd(),r=A.resolve(t,e.out??w),n=await fe(t,e),i=n.config,o=await ft(t,i.mode,n.includePatterns,n.ignorePatterns);o.length===0?c.warn("No files matched the scan configuration."):c.info(`Scanning ${o.length} file(s) in ${i.mode} mode.`);let s=await ce({cwd:t,files:o,strict:i.strict,suppress:i.suppress??[],treatNewlyAs:i.treatNewlyAs,cliVersion:ye.version??"0.0.0"});await q(r);let l=me(s);await P(A.join(r,"report.json"),le(s)),await P(A.join(r,"report.md"),l),await pe(A.join(r,"meta.json"),{cliVersion:s.meta.cliVersion,datasetVersion:s.meta.datasetVersion,generatedAt:s.meta.generatedAt,config:{path:n.configPath??null,mode:i.mode,strict:i.strict,treatNewlyAs:i.treatNewlyAs,maxLimited:i.maxLimited,suppress:i.suppress,include:i.include,ignore:i.ignore},filesAnalyzed:o});let a=e.printFullReport?l:ge(l);a.trim().length>0&&console.log(a),c.info(`Report written to ${r}`)}async function ft(e,t,r,n){let i=dt(n),o=mt();o.add(i);let s=r.map(u=>ut.filter(u,{dot:!0,matchBase:!0})),l=u=>!(!pt.includes(A.extname(u).toLowerCase())||o.ignores(u)||s.length>0&&!s.some(m=>m(u)));if(t==="repo"){let u=r.length>0?r:["**/*"],m=await lt(u,{cwd:e,gitignore:!0,dot:!0,ignore:i,onlyFiles:!0});return Array.from(new Set(m.filter(p=>l(p))))}let a=await de(e);return Array.from(new Set(a.filter(u=>l(u))))}function dt(e){let t=[];for(let r of e)t.push(r),r.endsWith("/")&&t.push(`${r}**`);return t}import gt from"path";async function we(e){let t=process.cwd(),r=e.input??v,n=gt.resolve(t,r),i;try{i=await T(n)}catch(u){if(e.inputSource==="default"&&u?.code==="ENOENT"){c.error(`No report found at ${v} \u2014 run \`base-lint scan\` first or pass --input`),process.exitCode=1;return}throw u}let o=Number(e.maxLimited??0),s=i.summary.limited,l=i.summary.newly,a=e.failOnWarn??i.meta.treatNewlyAs==="error";if(c.info(`Report summary \u2013 Limited: ${s}, Newly: ${l}, Widely: ${i.summary.widely}`),Number.isNaN(o))throw new Error("Invalid max-limited value.");if(s>o){c.error(`Limited findings (${s}) exceed the allowed maximum (${o}).`),process.exitCode=1;return}if(a&&l>0){c.error(`Newly findings (${l}) present and fail-on-warn is enabled.`),process.exitCode=1;return}c.info("Baseline policy satisfied.")}import{promises as be}from"fs";import yt from"path";async function Se(e){let t=process.cwd(),r=e.stickyMarker??"<!-- base-lint-sticky -->",n=yt.resolve(t,e.input),i=await be.readFile(n,"utf8"),o=process.env.GITHUB_TOKEN||process.env.GH_TOKEN,s=process.env.GITHUB_REPOSITORY,l=process.env.GITHUB_EVENT_NAME;if(!o||!s||!l){c.info("GitHub context not detected. Skipping sticky comment.");return}if(!l.startsWith("pull_request")){c.info(`Event ${l} is not a pull request. Skipping comment.`);return}let a=await ht();if(!a){c.info("No pull request number found in event payload. Skipping comment.");return}if(a.isFork){c.info("Pull request originates from a fork. Skipping sticky comment to avoid permission issues.");return}let[u,m]=s.split("/"),f=(await wt(u,m,a.number,o)).find(d=>d.body?.includes(r));if(f){await St(u,m,f.id,i,o)&&c.info(`Updated existing sticky comment #${f.id}.`);return}await bt(u,m,a.number,i,o)&&c.info(`Created sticky comment on PR #${a.number}.`)}async function ht(){let e=process.env.GITHUB_EVENT_PATH;if(!e)return null;try{let t=await be.readFile(e,"utf8"),r=JSON.parse(t),n=r?.pull_request?.number??r?.number;if(typeof n!="number")return null;let i=r?.pull_request?.base?.repo?.full_name,o=r?.pull_request?.head?.repo?.full_name;return{number:n,isFork:!!(o&&i&&o!==i)}}catch(t){return c.warn(`Failed to parse GitHub event payload: ${t.message}`),null}}async function wt(e,t,r,n){let i=`https://api.github.com/repos/${e}/${t}/issues/${r}/comments?per_page=100`,o=await M(i,n);if(!o.ok){if(o.status===403||o.status===404)return c.warn(`Insufficient permissions to list comments (status ${o.status}).`),[];throw new Error(`Failed to list comments: ${o.status}`)}return await o.json()}async function bt(e,t,r,n,i){let o=`https://api.github.com/repos/${e}/${t}/issues/${r}/comments`,s=await M(o,i,{method:"POST",body:JSON.stringify({body:n})});if(!s.ok){if(s.status===403||s.status===404)return c.warn(`Insufficient permissions to create comment (status ${s.status}).`),!1;throw new Error(`Failed to create comment: ${s.status}`)}return!0}async function St(e,t,r,n,i){let o=`https://api.github.com/repos/${e}/${t}/issues/comments/${r}`,s=await M(o,i,{method:"PATCH",body:JSON.stringify({body:n})});if(!s.ok){if(s.status===403||s.status===404)return c.warn(`Insufficient permissions to update comment (status ${s.status}).`),!1;throw new Error(`Failed to update comment: ${s.status}`)}return!0}async function M(e,t,r={}){let n=new Headers(r.headers??{});return n.set("Authorization",`Bearer ${t}`),n.set("Accept","application/vnd.github+json"),n.set("User-Agent","base-lint-cli"),fetch(e,{...r,headers:n})}import Nt from"path";async function xe(e){let t=process.cwd(),r=Nt.resolve(t,e.input),n=await T(r),i=process.env.GITHUB_TOKEN||process.env.GH_TOKEN,o=process.env.GITHUB_REPOSITORY,s=process.env.GITHUB_EVENT_NAME??"",l=process.env.GITHUB_SHA;if(!i||!o){c.info("GitHub context not detected. Skipping annotations.");return}let a=l;if(s.startsWith("pull_request")){let y=await vt();if(y?.isFork){c.info("Pull request originates from a fork. Skipping annotations.");return}y?.headSha&&(a=y.headSha)}if(!a){c.info("GitHub context not detected. Skipping annotations.");return}let u=xt(n.findings,n.meta.treatNewlyAs),m=Math.max(1,Number(e.batchSize??"50")),p=`Limited: ${n.summary.limited} \xB7 Newly: ${n.summary.newly} \xB7 Widely: ${n.summary.widely}`,f=Tt(n),[h,d]=o.split("/"),g="Base Lint",ve=new Date().toISOString(),G={title:g,summary:p,text:"Generated by base-lint."},Ae=u.slice(0,m),S=await Ne(`https://api.github.com/repos/${h}/${d}/check-runs`,i,{method:"POST",body:JSON.stringify({name:g,head_sha:a,status:"completed",conclusion:f,completed_at:ve,output:{...G,annotations:Ae}})});if(!S.ok){if(S.status===403||S.status===404){c.warn(`Insufficient permissions to create check run (status ${S.status}).`);return}throw new Error(`Failed to create check run: ${S.status}`)}let V=(await S.json()).id;if(!V){c.warn("Check run created without id. Skipping additional annotations.");return}let F=u.slice(m);if(F.length===0)return;let W=[];for(let y=0;y<F.length;y+=m)W.push(F.slice(y,y+m));for(let y of W){let z=await Ne(`https://api.github.com/repos/${h}/${d}/check-runs/${V}`,i,{method:"PATCH",body:JSON.stringify({status:"completed",conclusion:f,completed_at:new Date().toISOString(),output:{...G,annotations:y}})});if(!z.ok){c.warn(`Failed to append annotations (status ${z.status}).`);break}}}function xt(e,t){let r=[];for(let n of e){if(n.baseline==="widely")continue;let i=Et(n.baseline,t),o=n.line??1,s=n.column??void 0;r.push({path:n.file,start_line:o,end_line:o,start_column:s,end_column:s,annotation_level:i,title:n.featureName,message:`${n.featureName} is ${n.baseline}. ${n.guidance}`})}return r}function Et(e,t){return e==="limited"||t==="error"?"failure":t==="ignore"?"notice":"warning"}function Tt(e){return e.summary.limited>0||e.meta.treatNewlyAs==="error"&&e.summary.newly>0?"failure":e.summary.newly>0?"neutral":"success"}async function vt(){let e=process.env.GITHUB_EVENT_PATH;if(!e)return null;try{let t=await T(e),r=t?.pull_request?.base?.repo?.full_name,n=t?.pull_request?.head?.repo?.full_name,i=!!(n&&r&&n!==r),o=typeof t?.pull_request?.head?.sha=="string"?t.pull_request.head.sha:void 0;return{isFork:i,headSha:o}}catch(t){return c.warn(`Failed to read event payload: ${t.message}`),null}}async function Ne(e,t,r={}){let n=new Headers(r.headers??{});return n.set("Authorization",`Bearer ${t}`),n.set("Accept","application/vnd.github+json"),n.set("User-Agent","base-lint-cli"),fetch(e,{...r,headers:n})}import At from"path";import{promises as Rt}from"fs";async function Ee(e={}){let t=process.cwd(),r=At.resolve(t,e.out??w);try{await Rt.rm(r,{recursive:!0,force:!0}),c.info(`Removed report directory at ${r}`)}catch(n){let i=n instanceof Error?n.message:String(n);throw c.error(`Failed to remove report directory at ${r}: ${i}`),n}}var Te={name:"base-lint",version:"1.0.7",description:"Lint your repo against Web Baseline policies",license:"MIT",bugs:{url:"https://github.com/ej-sanmartin/base-lint/issues"},homepage:"https://github.com/ej-sanmartin/base-lint#readme",repository:{type:"git",url:"https://github.com/ej-sanmartin/base-lint",directory:"packages/cli"},funding:{type:"individual",url:"https://Ko-fi.com/esanmartin"},type:"module",bin:{"base-lint":"dist/index.js"},files:["dist"],imports:{vitest:"../../tests/mocks/vitest.js"},scripts:{build:"tsup --config tsup.config.ts",dev:"tsx src/index.ts --help",prepublishOnly:"npm run build"},dependencies:{"@typescript-eslint/typescript-estree":"^6.21.0",commander:"^11.1.0",globby:"^13.2.2",ignore:"^5.3.1",minimatch:"^9.0.3","node-html-parser":"^6.1.11",picocolors:"^1.0.0",postcss:"^8.4.35","web-features":"^2.0.0"},devDependencies:{"@types/node":"^20.11.30",tsup:"^8.0.1",tsx:"^4.7.1",typescript:"^5.4.2"},keywords:["lint","baseline","eslint","stylelint","typescript","javascript","css","cli","ci","bot","static-analysis","code-quality","code-style","automation","best-practices"]};var b=new It;b.name("base-lint").description("Baseline-aware linting for modern web platform features").version(Te.version??"0.0.0");b.command("scan").description("Scan files for Baseline coverage issues").option("--mode <mode>","analysis mode: diff or repo","diff").option("--out <dir>","output directory for reports",w).option("--strict","enable strict feature detection").option("--treat-newly <behavior>","treat Newly features as warn|error|ignore","warn").option("--config <path>","path to config file override").option("--print-full-report","print the full Markdown report to stdout").action(async e=>{try{await he(e)}catch(t){x(t)}});b.command("enforce").description("Enforce policy against a previously generated JSON report").option("--input <file>","path to JSON report",v).option("--max-limited <count>","maximum number of limited findings","0").option("--fail-on-warn","treat Newly findings as failures").action(async(e,t)=>{try{await we({...e,inputSource:t.getOptionValueSource("input")})}catch(r){x(r)}});b.command("comment").description("Create or update a sticky pull request summary comment on GitHub").requiredOption("--input <file>","Markdown report to post").option("--sticky-marker <marker>","HTML comment marker for sticky comment","<!-- base-lint-sticky -->").action(async e=>{try{await Se(e)}catch(t){x(t)}});b.command("annotate").description("Publish GitHub Checks annotations for findings").requiredOption("--input <file>","JSON report to annotate from").option("--batch-size <n>","number of annotations per API request","50").action(async e=>{try{await xe(e)}catch(t){x(t)}});b.command("clean").description("Remove generated Baseline report artifacts").option("--out <dir>","report directory to delete",w).action(async e=>{try{await Ee(e)}catch(t){x(t)}});b.parseAsync().catch(e=>{x(e)});function x(e){let t=e instanceof Error?e.message:String(e);console.error(t),process.exitCode=1}
